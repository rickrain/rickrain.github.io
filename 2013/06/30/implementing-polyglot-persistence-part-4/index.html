<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="d ago"><meta name="hour-prompt" content="hr ago"><meta name="minute-prompt" content="min ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.3.1" /><meta property="og:title" content="Implementing Polyglot Persistence – Part 4" /><meta property="og:locale" content="en" /><meta name="description" content="This post continues the journey of implementing a MongoDB repository, this time focusing on the search implementation." /><meta property="og:description" content="This post continues the journey of implementing a MongoDB repository, this time focusing on the search implementation." /><link rel="canonical" href="https://rickrainey.com/2013/06/30/implementing-polyglot-persistence-part-4/" /><meta property="og:url" content="https://rickrainey.com/2013/06/30/implementing-polyglot-persistence-part-4/" /><meta property="og:site_name" content="Rick Rainey" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2013-06-30T16:06:04-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Implementing Polyglot Persistence – Part 4" /><meta name="twitter:site" content="@rickraineytx" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-09-23T19:53:21-05:00","datePublished":"2013-06-30T16:06:04-05:00","description":"This post continues the journey of implementing a MongoDB repository, this time focusing on the search implementation.","headline":"Implementing Polyglot Persistence – Part 4","mainEntityOfPage":{"@type":"WebPage","@id":"https://rickrainey.com/2013/06/30/implementing-polyglot-persistence-part-4/"},"url":"https://rickrainey.com/2013/06/30/implementing-polyglot-persistence-part-4/"}</script><title>Implementing Polyglot Persistence – Part 4 | Rick Rainey</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Rick Rainey"><meta name="application-name" content="Rick Rainey"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/rick-outdoors.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Rick Rainey</a></div><div class="site-subtitle font-italic">Where I share my learnings to help others</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/rickrain" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/rickraineytx" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['rickrain','hotmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Implementing Polyglot Persistence – Part 4</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Implementing Polyglot Persistence – Part 4</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Rick Rainey </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Jun 30, 2013, 4:06 PM -0500" >Jun 30, 2013<i class="unloaded">2013-06-30T16:06:04-05:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Sep 23, 2021, 7:53 PM -0500" >Sep 23, 2021<i class="unloaded">2021-09-23T19:53:21-05:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1479 words">8 min read</span></div></div><div class="post-content"><p>This post continues the journey of implementing a MongoDB repository, this time focusing on the search implementation.</p><h2 id="implementing-the-product-repository-continued">Implementing the Product Repository (continued…)</h2><p>I structured my API for search to allow me to pass in the property I want to search on and a search value for that property. The goal here wasn’t to be a rich searching engine but instead to give some common scenarios and see how they could be implemented. A few examples of search URL’s I wanted to support are…</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>// Find products whose Name field contains “sql” 
GET /api/product/search?property=name&amp;value=sql

// Find products whose Price field equals 19.99
GET /api/product/search?property=price&amp;value=19.99

// Find products in the "clothing" category
GET /api/product/search?property=categories&amp;value=clothing
</pre></table></code></div></div><p>I also wanted to be able to do searches on properties/fields that are unknown to the base <strong>Product</strong> model.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Plaintext "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>// Find products with a “Fabric” property equal to “cotton” 
GET /api/product/search?property=Fabric&amp;value=cotton

// Find products with a "Voltage" property containing "18"
GET /api/product/search?property=Voltage&amp;value=18
</pre></table></code></div></div><p>Finally, I want all the searches to be case-insensitive, matching substrings (not just full string matches).</p><p>What I ended up with was a generic, yet powerful, search method. When I first started this, I thought I would have a search method using LINQ queries against my base <strong>Product</strong> model and another method for everything else. And that was what my first pass at this actually was. More on that later. However, after experimenting more with the API’s, I was able to get all my search requirements down to one short method that I’m <em>mostly satisfied with</em>.</p><p>When searching on properties that are in in my base <strong>Product model</strong>, I was able to be very precise about the search implementation. For example, since I know about the properties in my model, I can correct casing of the property name before issuing the query. Or, if the property is a complex type (array, nested document, etc.), then I can adjust the query for that particular type.</p><p>As I expanded my search capabilities beyond my model to any property that any product might have, things got a little thorny. For example, if I want to search on the “Voltage” property (a property not in my model), then the URL needs to specify the exact casing of that property (“Voltage” not “voltage”). And, who’s to say that some product in the collection may actually have a “voltage” property now, or in the future. In which case, a search on “Voltage” and a search on “voltage” would yield two different results. Not good! Another issue is searching properties unknown in my model that have complex structures. A lack of a model for these additional properties makes searching on them extremely challenging. In my implementation, I treat anything I don’t know about as a simple string search.</p><p>The point of all this is to support a point I made in an earlier post. Which is, <strong><em>just because you can store any random document into a collection, doesn’t mean you always should</em></strong>. Properties in your documents should be consistently named (and cased) throughout the collection. Try to think ahead about how you intend to use and query the documents in the collection and structure your model (schema) to support those needs. That was the basis for my <strong>Product</strong> model (although very small). It enables me to have some consistency throughout the collection. Without it, searching the collection would otherwise have been very challenging.</p><p>Now, on to the code…</p><h2 id="the-search-implementation">The Search Implementation</h2><p>In the constructor for my repository, I added this line of code to reflect over my base <strong>Product</strong> model, giving me a list of <strong>PropertyInfo</strong> objects that I can leverage in my search method. This is just the way I chose to do this. If you use the LINQ query support then this is not necessary.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c1">// Get a list of properties I know about (from the model).</span>
<span class="n">knownProperties</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Product</span><span class="p">).</span><span class="nf">GetProperties</span><span class="p">().</span><span class="nf">ToList</span><span class="p">();</span>
</pre></table></code></div></div><p>My search method starts off like this, taking advantage of the knownProperties list. All I’m doing here is properly casing the srchProperty when the property specified is one I know about.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c1">// If this is a property/field I know about, then I can be more </span>
<span class="c1">// precise about how I construct the query.</span>
<span class="kt">var</span> <span class="n">knownProperty</span> <span class="p">=</span> <span class="n">knownProperties</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="nf">ToLower</span><span class="p">()</span> <span class="p">==</span> <span class="n">srchProperty</span><span class="p">.</span><span class="nf">ToLower</span><span class="p">());</span>

<span class="c1">// Set the name of the property to exactly match casing.</span>
<span class="n">srchProperty</span> <span class="p">=</span> <span class="p">(</span><span class="n">knownProperty</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">?</span> <span class="n">knownProperty</span><span class="p">.</span><span class="n">Name</span> <span class="p">:</span> <span class="n">srchProperty</span><span class="p">;</span>
</pre></table></code></div></div><p>Next, I setup my default query. This query does a simple string search on the srchProperty to see if the value contains the srchValue. It also ignores casing inconsistencies.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c1">// Query for searching a property's value.  </span>
<span class="c1">// This is the default query unless otherwise specified.</span>
<span class="n">IMongoQuery</span> <span class="n">query</span> <span class="p">=</span> <span class="n">Query</span><span class="p">.</span><span class="nf">Matches</span><span class="p">(</span>
    <span class="n">srchProperty</span><span class="p">,</span>
    <span class="k">new</span> <span class="nf">BsonRegularExpression</span><span class="p">(</span>
        <span class="k">new</span> <span class="nf">Regex</span><span class="p">(</span><span class="n">srchValue</span><span class="p">,</span> <span class="n">RegexOptions</span><span class="p">.</span><span class="n">IgnoreCase</span><span class="p">)));</span>
</pre></table></code></div></div><p>If the search is on a property that is in my model, then I can leverage what I know about the property to make the search more intelligent. My <strong>Product</strong> model contains 3 different types of properties (<code class="language-plaintext highlighter-rouge">string</code>, <code class="language-plaintext highlighter-rouge">double</code>, and <code class="language-plaintext highlighter-rouge">List&lt;string&gt;</code>). Since my default query (above) already handles <code class="language-plaintext highlighter-rouge">string</code>, I just need to handle the other two types in my model.</p><p>The first type I handle is the <code class="language-plaintext highlighter-rouge">double</code>, which is what my <code class="language-plaintext highlighter-rouge">Product.Price</code> is. Since the parameter is passed in from the URL as a <code class="language-plaintext highlighter-rouge">string</code> (again, that’s my default), I simply convert it to a double and overwrite query with a precise query for double.</p><p>Next is the <code class="language-plaintext highlighter-rouge">List&lt;string&gt;</code> type, which is what <code class="language-plaintext highlighter-rouge">Product.Categories</code> is. These 2 lines of code overwrite the query to search the list of categories for each product, matching any product whose category(s) contain the srchValue passed in. In other words, I can search for “book”, “Book”, or even “OOK” and I’ll get back the same list of products. Again, having a model you can reference makes implementing the query very easy and more powerful.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="p">(</span><span class="n">knownProperty</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">knownProperty</span><span class="p">.</span><span class="n">PropertyType</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="kt">double</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="kt">double</span> <span class="n">srchDouble</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="kt">double</span><span class="p">.</span><span class="nf">TryParse</span><span class="p">(</span><span class="n">srchValue</span><span class="p">,</span> <span class="k">out</span> <span class="n">srchDouble</span><span class="p">))</span>
                        <span class="n">query</span> <span class="p">=</span> <span class="n">Query</span><span class="p">.</span><span class="nf">EQ</span><span class="p">(</span><span class="n">knownProperty</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">srchDouble</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">knownProperty</span><span class="p">.</span><span class="n">PropertyType</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;))</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">rx</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Regex</span><span class="p">(</span><span class="n">srchValue</span><span class="p">,</span> <span class="n">RegexOptions</span><span class="p">.</span><span class="n">IgnoreCase</span><span class="p">);</span>
        <span class="n">query</span> <span class="p">=</span> <span class="n">Query</span><span class="p">.</span><span class="nf">All</span><span class="p">(</span><span class="n">knownProperty</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">BsonValue</span><span class="p">&gt;()</span> <span class="p">{</span> <span class="n">BsonValue</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="n">rx</span><span class="p">)</span> <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>For searches on properties I don’t know about, I default to the string query (above). However, in this case, I need to tell MongoDB to also check if the property exists because now I’m searching on properties that not all documents in the collection will have.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c1">// A query to check if the property exists in the collection.</span>
<span class="kt">var</span> <span class="n">qPropExists</span> <span class="p">=</span> <span class="n">Query</span><span class="p">.</span><span class="nf">Exists</span><span class="p">(</span><span class="n">srchProperty</span><span class="p">);</span>

<span class="c1">// Pull the two query conditions together into one query.</span>
<span class="n">query</span> <span class="p">=</span> <span class="n">Query</span><span class="p">.</span><span class="nf">And</span><span class="p">(</span><span class="n">qPropExists</span><span class="p">,</span> <span class="n">query</span><span class="p">);</span>
</pre></table></code></div></div><p>Finally, I issue the query and return the results.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="k">return</span> <span class="n">MongoHelper</span><span class="p">.</span><span class="n">ProductsCollection</span><span class="p">.</span><span class="n">FindAs</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(</span><span class="n">query</span><span class="p">).</span>
    <span class="nf">Skip</span><span class="p">(</span><span class="n">pageIndex</span> <span class="p">*</span> <span class="n">pageSize</span><span class="p">).</span><span class="nf">Take</span><span class="p">(</span><span class="n">pageSize</span><span class="p">).</span><span class="n">ToList</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;();</span>
</pre></table></code></div></div><h2 id="query-builder-or-linq">Query Builder or LINQ</h2><p>Why did I choose this approach over using LINQ for queries against my <strong>Product</strong> model? I wanted to support queries against my model and queries on properties that are not part of my model in as few lines of code as possible. By taking this approach, I was able to have just one line issue the query to MongoDB. The only difference is how the query is constructed.</p><p>There was also a “gotcha” I ran into using LINQ that I was able to easily resolve using the Query builder approach. Recall that I wanted my searches to be case-insensitive. At first I thought this would be very easy using LINQ. After all, this line of code compiles just fine!</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">productQuery</span> <span class="p">=</span> <span class="n">MongoHelper</span><span class="p">.</span><span class="n">ProductsCollection</span><span class="p">.</span><span class="n">AsQueryable</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;().</span>
    <span class="nf">Where</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span><span class="p">.</span><span class="n">Categories</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">srchValue</span><span class="p">,</span> <span class="n">StringComparer</span><span class="p">.</span><span class="n">CurrentCultureIgnoreCase</span><span class="p">));</span>
</pre></table></code></div></div><p>However, when I ran it, I got this runtime exception.</p><p><img data-proofer-ignore data-src="/assets/img/pp-part4-01.png" alt="ArgumentException" /></p><p>In fact, this condition (and potentially others) is documented <a href="http://mongodb.github.io/mongo-csharp-driver/2.2/getting_started/#csharp-driver-linq-tutorial">here</a>.</p><p><img data-proofer-ignore data-src="/assets/img/pp-part4-02.png" alt="ArgumentException" /></p><p>and here…</p><p><img data-proofer-ignore data-src="/assets/img/pp-part4-03.png" alt="Supported Where Clauses" /></p><p>Bummer! This was the only condition like this I discovered. Otherwise, the LINQ support was fantastic.</p><p>Anyway, there were a couple of easy ways to resolve this. I chose to do so using the Query builder approach, incorporating a simple regular expression into my query (see above). Not only was I able to achieve a case-insensitive search on the Categories property, but I was also able to easily support substrings of the category being searched for – something my LINQ query wouldn’t have done even if it was supported.</p><h2 id="conclusion">Conclusion</h2><p>Using Fiddler (or a browser since these are GET operations), it is easy to search the products catalog. My full implementation is available <a href="https://github.com/rickrain/ImplementingPolyglotPersistence">here</a> for anyone interested in trying it out.</p><p>MongoDB supports very powerful queries across collections, regardless of the schema (or lack of) from one document to the next. This post showed how you can use the MongoDB C# drivers to query the database. More importantly, I hope it illustrates how having some degree of schema in your application model will help query the collection effectively.</p><div id="disqus_thread"></div><script> /** * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS. * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/ /* var disqus_config = function () { this.page.url = ""; // Replace PAGE_URL with your page's canonical URL variable this.page.identifier = "/2013/06/30/implementing-polyglot-persistence-part-4/"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable }; */ (function() { // DON'T EDIT BELOW THIS LINE var d = document, s = d.createElement('script'); s.src = 'https://rickrainey.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Implementing Polyglot Persistence – Part 4 - Rick Rainey&url=https://rickrainey.com/2013/06/30/implementing-polyglot-persistence-part-4/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Implementing Polyglot Persistence – Part 4 - Rick Rainey&u=https://rickrainey.com/2013/06/30/implementing-polyglot-persistence-part-4/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Implementing Polyglot Persistence – Part 4 - Rick Rainey&url=https://rickrainey.com/2013/06/30/implementing-polyglot-persistence-part-4/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/ubuntu-dev-setup/">Developer Laptop Setup on Ubuntu</a><li><a href="/posts/ckad-tips/">CKAD Exam Tips</a><li><a href="/2013/04/16/polyglot-persistence-in-windows-azure/">Polyglot Persistence in Windows Azure</a><li><a href="/2013/05/22/implementing-polyglot-persistence-part-1/">Implementing Polyglot Persistence – Part 1</a><li><a href="/2013/05/27/setting-up-a-neo4j-server-running-on-ubuntu-in-windows-azure/">Setting up a Neo4j Server running on Ubuntu in Windows Azure</a></ul></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/ubuntu-dev-setup/"><div class="card-body"> <span class="timeago small" >Dec 6, 2021<i class="unloaded">2021-12-06T09:00:00-06:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Developer Laptop Setup on Ubuntu</h3><div class="text-muted small"><p> This blog is really a crutch for me to remember how I like to setup my Ubuntu desktop for development work. I recently got a new laptop and had to go through the process again of setting it up the ...</p></div></div></a></div><div class="card"> <a href="/posts/ckad-tips/"><div class="card-body"> <span class="timeago small" >Oct 12, 2021<i class="unloaded">2021-10-12T10:00:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>CKAD Exam Tips</h3><div class="text-muted small"><p> I recently took and passed the CKAD Exam and now the proud owner of the CKAD Certification issued by The Linux Foundation. Like so many others who have accomplished this, I decided to share some ti...</p></div></div></a></div><div class="card"> <a href="/2016/06/22/add-a-custom-device-to-the-azure-iot-suite-remote-monitoring-solution/"><div class="card-body"> <span class="timeago small" >Jun 22, 2016<i class="unloaded">2016-06-22T16:06:04-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Add a custom device to the Azure IoT Suite Remote Monitoring solution</h3><div class="text-muted small"><p> Today, Azure IoT Suite provides two end-to-end IoT solutions; Predictive Maintenance and Remote Monitoring. These solutions can be deployed into your Azure subscription and running in just a few mi...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/2013/06/25/implementing-polyglot-persistence-part-3/" class="btn btn-outline-primary" prompt="Older"><p>Implementing Polyglot Persistence – Part 3</p></a> <a href="/2013/07/14/implementing-polyglot-persistence-part-5/" class="btn btn-outline-primary" prompt="Newer"><p>Implementing Polyglot Persistence – Part 5</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://rickrainey.com/2013/06/30/implementing-polyglot-persistence-part-4/'; this.page.identifier = '/2013/06/30/implementing-polyglot-persistence-part-4/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://rickrainey.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (modeToggle !== null) { modeToggle.addEventListener('click', reloadDisqus); window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/rickraineytx">Rick Rainey</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
