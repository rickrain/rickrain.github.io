<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="d ago"><meta name="hour-prompt" content="hr ago"><meta name="minute-prompt" content="min ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.3.1" /><meta property="og:title" content="Calling Azure Service Management REST API’s from C#" /><meta property="og:locale" content="en" /><meta name="description" content="Introduction The Management Portal for Windows Azure provides a nice user experience for many service management operations such as creating cloud services, storage accounts, virtual machines, virtual networks, and so on. If you want to automate such operations, then the Azure PowerShell Cmdlets are a great choice and you can find a plethora of examples on how to use them on my close friend Michael Washam’s blog. On the other hand, if PowerShell is not your thing and you would prefer a C# approach, then the Windows Azure Service Management REST API’s are available for you. Using the REST API’s gives you full control, but at the expense of some added complexity." /><meta property="og:description" content="Introduction The Management Portal for Windows Azure provides a nice user experience for many service management operations such as creating cloud services, storage accounts, virtual machines, virtual networks, and so on. If you want to automate such operations, then the Azure PowerShell Cmdlets are a great choice and you can find a plethora of examples on how to use them on my close friend Michael Washam’s blog. On the other hand, if PowerShell is not your thing and you would prefer a C# approach, then the Windows Azure Service Management REST API’s are available for you. Using the REST API’s gives you full control, but at the expense of some added complexity." /><link rel="canonical" href="https://rickrainey.com/2013/10/17/calling-azure-service-management-rest-apis-from-c/" /><meta property="og:url" content="https://rickrainey.com/2013/10/17/calling-azure-service-management-rest-apis-from-c/" /><meta property="og:site_name" content="Rick Rainey" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2013-10-17T16:06:04-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Calling Azure Service Management REST API’s from C#" /><meta name="twitter:site" content="@rickraineytx" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-09-22T18:01:09-05:00","datePublished":"2013-10-17T16:06:04-05:00","description":"Introduction The Management Portal for Windows Azure provides a nice user experience for many service management operations such as creating cloud services, storage accounts, virtual machines, virtual networks, and so on. If you want to automate such operations, then the Azure PowerShell Cmdlets are a great choice and you can find a plethora of examples on how to use them on my close friend Michael Washam’s blog. On the other hand, if PowerShell is not your thing and you would prefer a C# approach, then the Windows Azure Service Management REST API’s are available for you. Using the REST API’s gives you full control, but at the expense of some added complexity.","headline":"Calling Azure Service Management REST API’s from C#","mainEntityOfPage":{"@type":"WebPage","@id":"https://rickrainey.com/2013/10/17/calling-azure-service-management-rest-apis-from-c/"},"url":"https://rickrainey.com/2013/10/17/calling-azure-service-management-rest-apis-from-c/"}</script><title>Calling Azure Service Management REST API's from C# | Rick Rainey</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Rick Rainey"><meta name="application-name" content="Rick Rainey"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/rick-outdoors.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Rick Rainey</a></div><div class="site-subtitle font-italic">Where I share my learnings to help others</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/rickrain" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/rickraineytx" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['rickrain','hotmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Calling Azure Service Management REST API's from C#</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Calling Azure Service Management REST API's from C#</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Rick Rainey </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Oct 17, 2013, 4:06 PM -0500" >Oct 17, 2013<i class="unloaded">2013-10-17T16:06:04-05:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, Sep 22, 2021, 6:01 PM -0500" >Sep 22, 2021<i class="unloaded">2021-09-22T18:01:09-05:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2453 words">13 min read</span></div></div><div class="post-content"><h2 id="introduction">Introduction</h2><p>The Management Portal for Windows Azure provides a nice user experience for many service management operations such as creating cloud services, storage accounts, virtual machines, virtual networks, and so on. If you want to automate such operations, then the Azure PowerShell Cmdlets are a great choice and you can find a plethora of examples on how to use them on my close friend Michael Washam’s blog. On the other hand, if PowerShell is not your thing and you would prefer a C# approach, then the Windows Azure Service Management REST API’s are available for you. Using the REST API’s gives you full control, but at the expense of some added complexity.</p><p>In this post, I’m going to show how to use a few of these REST API’s in a way that you can re-use – much like you would a client SDK ( hmmm, that would be nice ). I’ll cover enough to demonstrate use of common HTTP verbs such as <code class="language-plaintext highlighter-rouge">GET</code>, <code class="language-plaintext highlighter-rouge">POST</code> and <code class="language-plaintext highlighter-rouge">DELETE</code> and show how to serialize complex structures the API’s use so you don’t have to create or parse XML.</p><h2 id="solution-overview">Solution Overview</h2><p>To demonstrate, I’ve limited the scope of my solution to just three C# libraries (DLL’s), two of which use a small part of the Service Management REST API’s for Cloud Service and Data Center Location operations.</p><p><img data-proofer-ignore data-src="/assets/img/service-mgmt-rest-api-01.png" alt="Visual Studio Projects" /></p><p><strong>ServiceManagement</strong> is the base library for the two other libraries, providing basic requirements for any Service Manage REST API.</p><p><img data-proofer-ignore data-src="/assets/img/service-mgmt-rest-api-02.png" alt="ServiceManagement.dll" /></p><p>As you can see, I also created Unit Test projects for each of these libraries so you can see how the different libraries might be used in client code. In similar fashion, the <strong>ServiceManagement.Tests</strong> project is the base for the other two test projects. Later, I will cover how to run the tests.</p><p><img data-proofer-ignore data-src="/assets/img/service-mgmt-rest-api-03.png" alt="ServiceManagement.Tests.dll" /></p><h2 id="base-service-management">Base Service Management</h2><p>The <strong>ServiceManagement</strong> project defines a base class, BaseApi, that the other two projects ( and potentially future projects ) derive from. It encapsulates some basic things that all the REST API’s need such as a valid Azure subscription, a base URI for web requests, and an <a href="https://docs.microsoft.com/en-us/previous-versions/visualstudio/hh193681(v=vs.118)?redirectedfrom=MSDN">HttpClient</a> that already has the Azure subscription’s management certificate added to the client certificates collection for authentication. It does a few other things, but these are the main parts.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">BaseApi</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">AzureSubscription</span> <span class="n">azureSubscription</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">BaseApi</span><span class="p">(</span><span class="n">AzureSubscription</span> <span class="n">Subscription</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Subscription</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span>
                <span class="s">"Subscription"</span><span class="p">,</span> <span class="s">"Subscription parameter cannot be null."</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="n">azureSubscription</span> <span class="p">=</span> <span class="n">Subscription</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Base Uri for all Service Management APIs</span>
    <span class="k">public</span> <span class="k">virtual</span> <span class="n">Uri</span> <span class="n">ServiceManagementUri</span>
    <span class="p">{</span>
        <span class="k">get</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span>
                <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">"https://management.core.windows.net/{0}"</span><span class="p">,</span>
                <span class="n">azureSubscription</span><span class="p">.</span><span class="n">SubscriptionId</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Returns a WebRequestHandler with the AzureSubscriptions</span>
    <span class="c1">// management certificate already in the client certificates collection.</span>
    <span class="k">public</span> <span class="n">WebRequestHandler</span> <span class="n">RequestHandler</span>
    <span class="p">{</span>
        <span class="k">get</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">handler</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WebRequestHandler</span><span class="p">();</span>
            <span class="n">handler</span><span class="p">.</span><span class="n">ClientCertificates</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span>
                <span class="k">this</span><span class="p">.</span><span class="n">azureSubscription</span><span class="p">.</span><span class="n">ManagementCertificate</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">handler</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Returns an HttpClient instance using the RequestHandler for this instance.</span>
    <span class="c1">// Sets the base address and common headers for all services APIs.</span>
    <span class="c1">// Sets up the Accept header for xml format.</span>
    <span class="k">public</span> <span class="n">HttpClient</span> <span class="n">HttpClientInstance</span>
    <span class="p">{</span>
        <span class="k">get</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">httpClient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">RequestHandler</span><span class="p">);</span>
            <span class="n">httpClient</span><span class="p">.</span><span class="n">BaseAddress</span> <span class="p">=</span> <span class="n">ServiceManagementUri</span><span class="p">;</span>
            <span class="n">httpClient</span><span class="p">.</span><span class="n">DefaultRequestHeaders</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"x-ms-version"</span><span class="p">,</span> <span class="s">"2013-03-01"</span><span class="p">);</span>
            <span class="n">httpClient</span><span class="p">.</span><span class="n">DefaultRequestHeaders</span><span class="p">.</span><span class="n">Accept</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span>
                <span class="k">new</span> <span class="nf">MediaTypeWithQualityHeaderValue</span><span class="p">(</span><span class="s">"application/xml"</span><span class="p">));</span>

            <span class="k">return</span> <span class="n">httpClient</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>This project also defines an <strong>AzureSubscription</strong> class that holds the Azure Subscription Id and associated management certificate for the subscription. An instance of this class is required to instantiate <strong>BaseApi</strong> or any of it’s derived classes. To instantiate <strong>AzureSubscription</strong> you must provide a Subscription ID and Certificate Thumbprint.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">AzureSubscription</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="kt">string</span> <span class="n">subscriptionId</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">X509Certificate2</span> <span class="n">certificate</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">AzureSubscription</span><span class="p">(</span><span class="kt">string</span> <span class="n">SubscriptionId</span><span class="p">,</span> <span class="kt">string</span> <span class="n">CertificateThumbprint</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">SubscriptionId</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="s">"SubscriptionId is null or empty."</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="n">subscriptionId</span> <span class="p">=</span> <span class="n">SubscriptionId</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">certificate</span> <span class="p">=</span> <span class="nf">GetCertificate</span><span class="p">(</span><span class="n">CertificateThumbprint</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">SubscriptionId</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">subscriptionId</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>

    <span class="k">public</span> <span class="n">X509Certificate2</span> <span class="n">ManagementCertificate</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">certificate</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>

    <span class="c1">// Looks for the certificate by thumbprint in the "My" certificate store.</span>
    <span class="k">private</span> <span class="n">X509Certificate2</span> <span class="nf">GetCertificate</span><span class="p">(</span><span class="kt">string</span> <span class="n">thumbprint</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">List</span><span class="p">&lt;</span><span class="n">StoreLocation</span><span class="p">&gt;</span> <span class="n">locations</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">StoreLocation</span><span class="p">&gt;</span> <span class="p">{</span> 
            <span class="n">StoreLocation</span><span class="p">.</span><span class="n">CurrentUser</span><span class="p">,</span> 
            <span class="n">StoreLocation</span><span class="p">.</span><span class="n">LocalMachine</span> <span class="p">};</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">location</span> <span class="k">in</span> <span class="n">locations</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">X509Store</span> <span class="n">store</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">X509Store</span><span class="p">(</span><span class="s">"My"</span><span class="p">,</span> <span class="n">location</span><span class="p">);</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">store</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="n">OpenFlags</span><span class="p">.</span><span class="n">ReadOnly</span> <span class="p">|</span> <span class="n">OpenFlags</span><span class="p">.</span><span class="n">OpenExistingOnly</span><span class="p">);</span>
                <span class="n">X509Certificate2Collection</span> <span class="n">certificates</span> <span class="p">=</span> <span class="n">store</span><span class="p">.</span><span class="n">Certificates</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span>
                  <span class="n">X509FindType</span><span class="p">.</span><span class="n">FindByThumbprint</span><span class="p">,</span> <span class="n">thumbprint</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">certificates</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">1</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">return</span> <span class="n">certificates</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">finally</span>
            <span class="p">{</span>
                <span class="n">store</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span>
          <span class="s">"A certificate with thumbprint '{0}' could not be located."</span><span class="p">,</span>
          <span class="n">thumbprint</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>With this base library in place, I’ll transition now to implementing the libraries that will call the various Service Management REST API’s.</p><h2 id="operations-on-data-center-locations">Operations on Data Center Locations</h2><p>The <a href="https://docs.microsoft.com/en-us/previous-versions/azure/reference/gg441299(v=azure.100)?redirectedfrom=MSDN">Operations on Locations</a> is very simple with just one operation, <a href="https://docs.microsoft.com/en-us/previous-versions/azure/reference/gg441293(v=azure.100)?redirectedfrom=MSDN">List Locations</a>. It returns a list of data centers available to your subscription and a list of available services for each data center. The request is a simple GET request that returns XML that could be serialized into a complex structure.</p><h3 id="data-center-locations-model">Data Center Locations Model</h3><p>To support serialization into a structure I can code against, I defined three classes according to the REST API documentation for this operation.</p><p><img data-proofer-ignore data-src="/assets/img/service-mgmt-rest-api-04.png" alt="Locations - DataCenterLocation - Services" /></p><p><strong>Locations</strong> contains a collection of <strong>DataCenterLocation</strong>’s and <strong>DataCenterLocation</strong> contains a collection of available <strong>Services</strong> at that data center. Pretty straight forward.</p><p>What you have to be careful about are how the classes are named, the namespace, and the order of properties. If any of this is off then the data won’t serialize into the structure, even though it was returned in the underlying XML. This is where the <a href="https://docs.microsoft.com/en-us/dotnet/api/system.runtime.serialization.datacontractattribute?redirectedfrom=MSDN&amp;view=net-5.0">DataContract</a> and <a href="https://docs.microsoft.com/en-us/dotnet/api/system.runtime.serialization.datamemberattribute?redirectedfrom=MSDN&amp;view=net-5.0">DataMember</a> attributes come in handy. I decorated the classes with the necessary attributes according to the documentation so that the response will serialize correctly.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="nf">DataContract</span><span class="p">(</span>
    <span class="n">Namespace</span> <span class="p">=</span> <span class="s">"http://schemas.microsoft.com/windowsazure"</span><span class="p">,</span>
    <span class="n">Name</span><span class="p">=</span><span class="s">"Location"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">DataCenterLocation</span>
<span class="p">{</span>
    <span class="p">[</span><span class="nf">DataMember</span><span class="p">(</span><span class="n">Order</span> <span class="p">=</span> <span class="m">1</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="p">[</span><span class="nf">DataMember</span><span class="p">(</span><span class="n">Order</span> <span class="p">=</span> <span class="m">2</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">DisplayName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="p">[</span><span class="nf">DataMember</span><span class="p">(</span><span class="n">Order</span> <span class="p">=</span> <span class="m">3</span><span class="p">)]</span>
    <span class="k">public</span> <span class="n">Services</span> <span class="n">AvailableServices</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="p">[</span><span class="nf">CollectionDataContract</span><span class="p">(</span>
    <span class="n">Namespace</span> <span class="p">=</span> <span class="s">"http://schemas.microsoft.com/windowsazure"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">Locations</span> <span class="p">:</span> <span class="n">Collection</span><span class="p">&lt;</span><span class="n">DataCenterLocation</span><span class="p">&gt;</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="p">[</span><span class="nf">CollectionDataContract</span><span class="p">(</span>
    <span class="n">Namespace</span> <span class="p">=</span> <span class="s">"http://schemas.microsoft.com/windowsazure"</span><span class="p">,</span>
    <span class="n">ItemName</span> <span class="p">=</span> <span class="s">"AvailableService"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">Services</span> <span class="p">:</span> <span class="n">Collection</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span>
<span class="p">{</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="data-center-locations-api">Data Center Locations API</h3><p>Now that the model is defined, the implementation of the <strong>LocationsApi</strong> is quick and to the point.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">LocationsApi</span> <span class="p">:</span> <span class="n">BaseApi</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">LocationsApi</span><span class="p">(</span><span class="n">AzureSubscription</span> <span class="n">Subscription</span><span class="p">)</span> 
        <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">Subscription</span><span class="p">)</span>
    <span class="p">{</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">override</span> <span class="n">Uri</span> <span class="n">ServiceManagementUri</span>
    <span class="p">{</span>
        <span class="k">get</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">"{0}/locations"</span><span class="p">,</span>
                <span class="k">base</span><span class="p">.</span><span class="n">ServiceManagementUri</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">Locations</span><span class="p">.</span><span class="n">Models</span><span class="p">.</span><span class="n">Locations</span> <span class="nf">List</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Invoke REST API</span>
        <span class="n">HttpResponseMessage</span> <span class="n">response</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">HttpClientInstance</span><span class="p">.</span><span class="nf">GetAsync</span><span class="p">(</span><span class="s">""</span><span class="p">).</span><span class="n">Result</span><span class="p">;</span>
        <span class="n">response</span><span class="p">.</span><span class="nf">EnsureSuccessStatusCode</span><span class="p">();</span>

        <span class="n">List</span><span class="p">&lt;</span><span class="n">MediaTypeFormatter</span><span class="p">&gt;</span> <span class="n">formatters</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">MediaTypeFormatter</span><span class="p">&gt;(){</span>
            <span class="k">new</span> <span class="nf">XmlMediaTypeFormatter</span><span class="p">()</span>
        <span class="p">};</span>

        <span class="k">return</span> <span class="n">response</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="n">ReadAsAsync</span><span class="p">&lt;</span><span class="n">Locations</span><span class="p">.</span><span class="n">Models</span><span class="p">.</span><span class="n">Locations</span><span class="p">&gt;(</span><span class="n">formatters</span><span class="p">).</span><span class="n">Result</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Although there’s not much to it, I’ll explain the main points.</p><ul><li>The implementation of <strong>LocationsApi</strong> derives from <strong>BaseApi</strong> which I covered earlier. So, it gets basic support needed for Service Management REST API’s.<li>The <strong>ServiceManagementUri</strong> is overridden to return the correct Uri for operations specific to locations.<li>The one operation defined, which is <strong>List</strong>, uses the HttpClient instance from the base class to invoke the REST API and return back the response as an instance of <strong>Locations</strong> using the <strong>ReadAsAsync</strong> extension method.</ul><h3 id="using-the-locationsapi-in-client-code">Using the LocationsApi in Client Code</h3><p>This is an example of client code using the <strong>LocationsApi</strong> to get a list of data center locations.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="n">locationsApi</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">LocationsApi</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">subscription</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">locations</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">locationsApi</span><span class="p">.</span><span class="nf">List</span><span class="p">();</span>

<span class="c1">// Print out the locations collection.</span>
<span class="k">foreach</span> <span class="p">(</span><span class="n">DataCenterLocation</span> <span class="n">loc</span> <span class="k">in</span> <span class="n">locations</span><span class="p">)</span>
<span class="p">{</span>

    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Name: {0}"</span><span class="p">,</span> <span class="n">loc</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Display Name: {0}"</span><span class="p">,</span> <span class="n">loc</span><span class="p">.</span><span class="n">DisplayName</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Services:"</span><span class="p">);</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="kt">string</span> <span class="n">service</span> <span class="k">in</span> <span class="n">loc</span><span class="p">.</span><span class="n">AvailableServices</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"\t{0}"</span><span class="p">,</span> <span class="n">service</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>And here is the output for one of the six data centers returned for my subscription.</p><p><img data-proofer-ignore data-src="/assets/img/service-mgmt-rest-api-05.png" alt="Services API output" /></p><p>Personally, I like this a lot better than parsing XML.</p><h2 id="operations-on-cloud-services">Operations on Cloud Services</h2><p>The <a href="https://docs.microsoft.com/en-us/previous-versions/azure/reference/ee460812(v=azure.100)?redirectedfrom=MSDN">Operations on Cloud Services</a> is a little more involved and has several operations. For the sake of this blog, I’m just going to focus on two operations; <a href="https://docs.microsoft.com/en-us/previous-versions/azure/reference/gg441304(v=azure.100)?redirectedfrom=MSDN">Create Cloud Service</a> and <a href="https://docs.microsoft.com/en-us/previous-versions/azure/reference/gg441305(v=azure.100)?redirectedfrom=MSDN">Delete Cloud Service</a>. I chose these because they provide small examples of API’s using <code class="language-plaintext highlighter-rouge">POST</code> and <code class="language-plaintext highlighter-rouge">DELETE</code> http verbs.</p><h3 id="create-cloud-service-model">Create Cloud Service Model</h3><p>This time, I’m defining a model that I can POST to the REST API’s to create a cloud service. So, continuing in similar fashion, I defined a class, CreateHostedService, to support the minimum requirements needed to create a cloud service. Notice that I said “minimum”. These API’s can get extremely complex quickly. For the sake of demonstration, I’ve limited my code to handle just these minimum requirements. Feel free to contribute to my project on github if you want to build this out further.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="nf">DataContract</span><span class="p">(</span><span class="n">Namespace</span> <span class="p">=</span> <span class="s">"http://schemas.microsoft.com/windowsazure"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">CreateHostedService</span>
<span class="p">{</span>
    <span class="p">[</span><span class="nf">DataMember</span><span class="p">(</span><span class="n">Order</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">IsRequired</span><span class="p">=</span><span class="k">true</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">ServiceName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="p">[</span><span class="nf">DataMember</span><span class="p">(</span><span class="n">Order</span> <span class="p">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">IsRequired</span> <span class="p">=</span> <span class="k">true</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Label</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="p">[</span><span class="nf">DataMember</span><span class="p">(</span><span class="n">Order</span> <span class="p">=</span> <span class="m">3</span><span class="p">,</span> <span class="n">IsRequired</span> <span class="p">=</span> <span class="k">true</span><span class="p">)]</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Location</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="cloud-services-api">Cloud Services API</h3><p>Here again, a pretty trivial implementation with everything else in place.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">CloudServicesApi</span> <span class="p">:</span> <span class="n">BaseApi</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">CloudServicesApi</span><span class="p">(</span><span class="n">AzureSubscription</span> <span class="n">Subscription</span><span class="p">)</span>
        <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">Subscription</span><span class="p">)</span>
    <span class="p">{</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">override</span> <span class="n">Uri</span> <span class="n">ServiceManagementUri</span>
    <span class="p">{</span>
        <span class="k">get</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">"{0}/services/hostedservices"</span><span class="p">,</span>
                <span class="k">base</span><span class="p">.</span><span class="n">ServiceManagementUri</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">Uri</span> <span class="nf">Create</span><span class="p">(</span><span class="kt">string</span> <span class="n">ServiceName</span><span class="p">,</span> <span class="kt">string</span> <span class="n">Location</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Create the request body</span>
        <span class="kt">byte</span><span class="p">[]</span> <span class="n">serviceNameBytes</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">Text</span><span class="p">.</span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">ServiceName</span><span class="p">);</span>
        <span class="n">CreateHostedService</span> <span class="n">requestBody</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CreateHostedService</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">ServiceName</span> <span class="p">=</span> <span class="n">ServiceName</span><span class="p">,</span>
            <span class="n">Label</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="nf">ToBase64String</span><span class="p">(</span><span class="n">serviceNameBytes</span><span class="p">),</span>
            <span class="n">Location</span> <span class="p">=</span> <span class="n">Location</span>
        <span class="p">};</span>

        <span class="c1">// Invoke REST API call</span>
        <span class="n">HttpResponseMessage</span> <span class="n">response</span> <span class="p">=</span> 
            <span class="k">this</span><span class="p">.</span><span class="n">HttpClientInstance</span><span class="p">.</span><span class="n">PostAsXmlAsync</span><span class="p">&lt;</span><span class="n">CreateHostedService</span><span class="p">&gt;(</span><span class="s">""</span><span class="p">,</span> <span class="n">requestBody</span><span class="p">).</span><span class="n">Result</span><span class="p">;</span>
        <span class="n">response</span><span class="p">.</span><span class="nf">EnsureSuccessStatusCode</span><span class="p">();</span>

        <span class="k">return</span> <span class="n">response</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="n">Location</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Delete</span><span class="p">(</span><span class="kt">string</span> <span class="n">ServiceName</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Invoke REST API call</span>
        <span class="n">HttpResponseMessage</span> <span class="n">response</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">HttpClientInstance</span><span class="p">.</span><span class="nf">DeleteAsync</span><span class="p">(</span>
            <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">"{0}/{1}"</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">ServiceManagementUri</span><span class="p">,</span> <span class="n">ServiceName</span><span class="p">)).</span><span class="n">Result</span><span class="p">;</span>
        <span class="n">response</span><span class="p">.</span><span class="nf">EnsureSuccessStatusCode</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Like before, here are the main observations in this class library.</p><ul><li>The implementation of <strong>CloudServicesApi</strong> derives from <strong>BaseApi</strong> which I covered earlier. So, it gets basic support needed for Service Management REST API’s.<li>The <strong>ServiceManagementUri</strong> is overridden to return the correct Uri for these operations specific to cloud services.<li>The <strong>Create</strong> method constructs a <strong>CreateHostedService</strong> instance, populates it with required data to create the service. Then, it uses the HttpClient instance from the base class to invoke the REST API, passing the <strong>CreateHostedService</strong> instance in the request body using the <strong>PostAsAsync</strong> extension method.<li>The <strong>Delete</strong> method is about as simple as it gets. Just use <strong>DeleteAsync</strong> to issue an http <code class="language-plaintext highlighter-rouge">DELETE</code> to the appropriate Uri for the cloud service to be deleted.</ul><h3 id="using-the-cloudservicesapi-in-client-code">Using the CloudServicesApi in Client Code</h3><p>This is an example of client code using the <strong>CloudServicesApi</strong> to create a new cloud service and then delete it.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="c1">// Set name of new cloud service.</span>
<span class="kt">var</span> <span class="n">name</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="nf">NewGuid</span><span class="p">().</span><span class="nf">ToString</span><span class="p">();</span>

<span class="c1">// Set location of new cloud service to first US location </span>
<span class="c1">// found available in the current subscription.</span>
<span class="kt">var</span> <span class="n">locationsApi</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Locations</span><span class="p">.</span><span class="nf">LocationsApi</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">subscription</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">locations</span> <span class="p">=</span> <span class="n">locationsApi</span><span class="p">.</span><span class="nf">List</span><span class="p">();</span>
<span class="kt">string</span> <span class="n">location</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
<span class="k">foreach</span> <span class="p">(</span><span class="n">DataCenterLocation</span> <span class="n">dcLocation</span> <span class="k">in</span> <span class="n">locations</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dcLocation</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="nf">EndsWith</span><span class="p">(</span><span class="s">" US"</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">location</span> <span class="p">=</span> <span class="n">dcLocation</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// Create a cloud service.</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Creating cloud service '{0}' in data center '{1}'."</span><span class="p">,</span> 
    <span class="n">name</span><span class="p">,</span> <span class="n">location</span><span class="p">);</span>
<span class="n">cloudServicesApi</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CloudServicesApi</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">subscription</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">cloudServiceUri</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">cloudServicesApi</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">location</span><span class="p">);</span>

<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Cloud service created."</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">cloudServiceUri</span><span class="p">);</span>

<span class="c1">// Delete the same cloud service.</span>
<span class="k">this</span><span class="p">.</span><span class="n">cloudServicesApi</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>

<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Cloud service deleted."</span><span class="p">);</span>
</pre></table></code></div></div><p>Notice in this code that I’m also making use of the <strong>LocationsApi</strong> to pick a data center that’s available for my subscription and in the US.</p><p>And here is the output. I know the name is not very user friendly, but at least it’s unique!</p><p><img data-proofer-ignore data-src="/assets/img/service-mgmt-rest-api-06.png" alt="Create serivce output" /></p><p>So, there you have it. A few examples using Service Management REST API’s from C# using models to serialize and de-serialize complex structures. Extending this to support more complex API’s is largely going to come down to defining the models. The code to call the REST API’s is pretty short when you have a model to pass to and from the library.</p><p>I’m going to wrap things up now with a quick review of the Test Projects.</p><h2 id="running-the-test-projects">Running the Test Projects</h2><p>If you know me or have read previous posts, you know I don’t like writing client applications just for the sake of testing other code. So, I’ll try and use test projects when possible to avoid this. Plus, it’s just good development practice to do so.</p><h3 id="configure-the-unit-tests">Configure the Unit Tests</h3><p>All that is needed to configure this for your environment is to replace the subscriptionId and certThumbprint in the BaseApiTest.cs file.</p><p><img data-proofer-ignore data-src="/assets/img/service-mgmt-rest-api-07.png" alt="Initialize method" /></p><p>As I indicated earlier, all the test projects derive from this <strong>BaseApiTest</strong> class (just like the REST API’s projects). So, once you set this all the other test projects are good to go.</p><p>You can find these values in your Windows Azure Portal in the Settings tab. The management certificate must also be installed in your personal certificates store in either CurrentUser or LocalMachine.</p><h3 id="run-the-unit-tests">Run the Unit Tests</h3><p>First, build the solution.</p><div class="table-wrapper"><table><tbody><tr><td>Next, to run the Unit Tests, select **TEST<td>Windows<td>Test Explorer** from Visual Studio 2013’s menu. This will open the Test Explorer window where you should find all the tests I’ve provided so far. Click the Run All link to run all the tests or right-click on a single test to run just that test.</table></div><p><img data-proofer-ignore data-src="/assets/img/service-mgmt-rest-api-08.png" alt="Test Explorer" /></p><h3 id="view-the-output-of-the-unit-tests">View the Output of the Unit Tests</h3><p>Most of the tests I’ve written just write data to the Console as you saw previously. You can view this output by clicking on the test you’re interested in and looking for the <strong>Output</strong> link.</p><p><img data-proofer-ignore data-src="/assets/img/service-mgmt-rest-api-09.png" alt="Link to output" /></p><p>If you don’t see an <strong>Output</strong> link for a test, it’s just because I didn’t write anything to the console in the test code.</p><h2 id="conclusion">Conclusion</h2><p>In this post I showed how to program against the Service Management REST API’s using C#. I gave examples of how you can build models to pass data to/from the API’s that will make programming against them in client code simpler and more intuitive.</p><div id="disqus_thread"></div><script> /** * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS. * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/ /* var disqus_config = function () { this.page.url = ""; // Replace PAGE_URL with your page's canonical URL variable this.page.identifier = "/2013/10/17/calling-azure-service-management-rest-apis-from-c/"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable }; */ (function() { // DON'T EDIT BELOW THIS LINE var d = document, s = d.createElement('script'); s.src = 'https://rickrainey.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Calling Azure Service Management REST API's from C# - Rick Rainey&url=https://rickrainey.com/2013/10/17/calling-azure-service-management-rest-apis-from-c/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Calling Azure Service Management REST API's from C# - Rick Rainey&u=https://rickrainey.com/2013/10/17/calling-azure-service-management-rest-apis-from-c/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Calling Azure Service Management REST API's from C# - Rick Rainey&url=https://rickrainey.com/2013/10/17/calling-azure-service-management-rest-apis-from-c/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/ubuntu-dev-setup/">Developer Laptop Setup on Ubuntu</a><li><a href="/posts/ckad-tips/">CKAD Exam Tips</a><li><a href="/2013/04/16/polyglot-persistence-in-windows-azure/">Polyglot Persistence in Windows Azure</a><li><a href="/2013/05/22/implementing-polyglot-persistence-part-1/">Implementing Polyglot Persistence – Part 1</a><li><a href="/2013/05/27/setting-up-a-neo4j-server-running-on-ubuntu-in-windows-azure/">Setting up a Neo4j Server running on Ubuntu in Windows Azure</a></ul></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/ubuntu-dev-setup/"><div class="card-body"> <span class="timeago small" >Dec 6, 2021<i class="unloaded">2021-12-06T09:00:00-06:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Developer Laptop Setup on Ubuntu</h3><div class="text-muted small"><p> This blog is really a crutch for me to remember how I like to setup my Ubuntu desktop for development work. I recently got a new laptop and had to go through the process again of setting it up the ...</p></div></div></a></div><div class="card"> <a href="/posts/ckad-tips/"><div class="card-body"> <span class="timeago small" >Oct 12, 2021<i class="unloaded">2021-10-12T10:00:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>CKAD Exam Tips</h3><div class="text-muted small"><p> I recently took and passed the CKAD Exam and now the proud owner of the CKAD Certification issued by The Linux Foundation. Like so many others who have accomplished this, I decided to share some ti...</p></div></div></a></div><div class="card"> <a href="/2016/06/22/add-a-custom-device-to-the-azure-iot-suite-remote-monitoring-solution/"><div class="card-body"> <span class="timeago small" >Jun 22, 2016<i class="unloaded">2016-06-22T16:06:04-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Add a custom device to the Azure IoT Suite Remote Monitoring solution</h3><div class="text-muted small"><p> Today, Azure IoT Suite provides two end-to-end IoT solutions; Predictive Maintenance and Remote Monitoring. These solutions can be deployed into your Azure subscription and running in just a few mi...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/2013/09/18/securing-a-wcf-service-in-an-azure-web-role-with-http-tcp-endpoints-2/" class="btn btn-outline-primary" prompt="Older"><p>Securing a WCF Service in an Azure Web Role with HTTP & TCP Endpoints</p></a> <a href="/2013/12/11/it-works-fine-in-the-windows-azure-emulator-but-fails-when-i-publish-to-windows-azure/" class="btn btn-outline-primary" prompt="Newer"><p>It works fine in the Windows Azure Emulator but fails when I publish to Windows Azure</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://rickrainey.com/2013/10/17/calling-azure-service-management-rest-apis-from-c/'; this.page.identifier = '/2013/10/17/calling-azure-service-management-rest-apis-from-c/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://rickrainey.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (modeToggle !== null) { modeToggle.addEventListener('click', reloadDisqus); window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/rickraineytx">Rick Rainey</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
