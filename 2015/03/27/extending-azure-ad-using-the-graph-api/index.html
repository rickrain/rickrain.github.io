<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="d ago"><meta name="hour-prompt" content="hr ago"><meta name="minute-prompt" content="min ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.3.1" /><meta property="og:title" content="Extending Azure AD using the Graph API" /><meta property="og:locale" content="en" /><meta name="description" content="The Azure Active Directory Graph API enables some interesting scenarios that you can implement in your applications by enabling you to query and manipulate directory objects in Azure AD. In the last post I presented you with some common scenarios available via the Azure AD Graph API and showed how you can implement them using the Azure Active Directory Graph Client Library. In this post, I’m going to introduce you to another scenario made possible using Azure AD Graph API and then take you on a journey through its implementation." /><meta property="og:description" content="The Azure Active Directory Graph API enables some interesting scenarios that you can implement in your applications by enabling you to query and manipulate directory objects in Azure AD. In the last post I presented you with some common scenarios available via the Azure AD Graph API and showed how you can implement them using the Azure Active Directory Graph Client Library. In this post, I’m going to introduce you to another scenario made possible using Azure AD Graph API and then take you on a journey through its implementation." /><link rel="canonical" href="https://rickrainey.com/2015/03/27/extending-azure-ad-using-the-graph-api/" /><meta property="og:url" content="https://rickrainey.com/2015/03/27/extending-azure-ad-using-the-graph-api/" /><meta property="og:site_name" content="Rick Rainey" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2015-03-27T16:06:04-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Extending Azure AD using the Graph API" /><meta name="twitter:site" content="@rickraineytx" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-09-22T15:38:09-05:00","datePublished":"2015-03-27T16:06:04-05:00","description":"The Azure Active Directory Graph API enables some interesting scenarios that you can implement in your applications by enabling you to query and manipulate directory objects in Azure AD. In the last post I presented you with some common scenarios available via the Azure AD Graph API and showed how you can implement them using the Azure Active Directory Graph Client Library. In this post, I’m going to introduce you to another scenario made possible using Azure AD Graph API and then take you on a journey through its implementation.","headline":"Extending Azure AD using the Graph API","mainEntityOfPage":{"@type":"WebPage","@id":"https://rickrainey.com/2015/03/27/extending-azure-ad-using-the-graph-api/"},"url":"https://rickrainey.com/2015/03/27/extending-azure-ad-using-the-graph-api/"}</script><title>Extending Azure AD using the Graph API | Rick Rainey</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Rick Rainey"><meta name="application-name" content="Rick Rainey"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/rick-outdoors.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Rick Rainey</a></div><div class="site-subtitle font-italic">Where I share my learnings to help others</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/rickrain" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/rickraineytx" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['rickrain','hotmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Extending Azure AD using the Graph API</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Extending Azure AD using the Graph API</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Rick Rainey </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Mar 27, 2015, 4:06 PM -0500" >Mar 27, 2015<i class="unloaded">2015-03-27T16:06:04-05:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, Sep 22, 2021, 3:38 PM -0500" >Sep 22, 2021<i class="unloaded">2021-09-22T15:38:09-05:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2970 words">16 min read</span></div></div><div class="post-content"><p>The Azure Active Directory Graph API enables some interesting scenarios that you can implement in your applications by enabling you to query and manipulate directory objects in Azure AD. In the last post I presented you with some common scenarios available via the Azure AD Graph API and showed how you can implement them using the Azure Active Directory Graph Client Library. In this post, I’m going to introduce you to another scenario made possible using Azure AD Graph API and then take you on a journey through its implementation.</p><p>Applications often have requirements for user data that is beyond what we typically would get from the <a href="https://msdn.microsoft.com/en-us/library/system.security.claims.claimsprincipal.claims(v=vs.110).aspx">Claims</a> collection for an authenticated user. In such cases, it is very common to store additional user data, for example profile data, in a database and then use it as needed in the application. This is generally the best practice most developers follow. However, if your additional user data requirements are small and your application is protected by Azure AD, then the Azure AD Graph API gives you another technique you can use whereby you can extend the directory schema in Azure AD to include the data your application needs. This feature is called Azure AD Graph API Directory Schema Extensions and can be used to store and retrieve extension properties (ie: custom data) for a variety of object types in Azure AD.</p><p>This is really cool, but it does have some limitations so don’t think this should be your go-to solution for all scenarios like this. However, given the right situation, it can be a nifty and cost-effective solution for your application. The limitations of this feature are as follows:</p><ul><li>An extension property must be either a <strong>String</strong> type or <strong>Binary</strong> type.<li>The size of the data that can be stored in the extension property <strong>cannot exceed 256 bytes</strong>.<li>The directory objects that can be extended using extension properties are <a href="https://msdn.microsoft.com/library/azure/ad/graph/api/entity-and-complex-type-reference#UserEntity">User</a>, <a href="https://msdn.microsoft.com/library/azure/ad/graph/api/entity-and-complex-type-reference#GroupEntity">Group</a>, <a href="https://msdn.microsoft.com/library/azure/ad/graph/api/entity-and-complex-type-reference#TenantDetailEntity">TenantDetail</a>, <a href="https://msdn.microsoft.com/library/azure/ad/graph/api/entity-and-complex-type-reference#DeviceEntity">Device</a>, <a href="https://msdn.microsoft.com/library/azure/ad/graph/api/entity-and-complex-type-reference#ApplicationEntity">Application</a>, and <a href="https://msdn.microsoft.com/library/azure/ad/graph/api/entity-and-complex-type-reference#ServicePrincipalEntity">ServicePrincipal</a>.<li>A directory (or Azure AD tenant) can have <strong>up to 100 extension properties registered</strong>.</ul><h2 id="a-sample-scenario">A Sample Scenario</h2><p>Now that we know what our limitations are let’s look at a scenario. Assume that I’m building a line-of-business application to manage parking passes for employees. In addition to the employee information I can get from Azure AD I also need some basic vehicle information about the employee’s vehicle so building security knows which vehicles are authorized to be in the parking lot or garage. If this is all I need, then using schema extensions provides a perfect alternative to taking a traditional database approach. Let’s see how this can be done using the Azure AD Graph API Directory Schema Extensions and the Azure AD Graph Client Library.</p><h2 id="register-a-new-application-in-azure-ad">Register a New Application in Azure AD</h2><p>For this post I’m using the same application I registered in the previous post to demonstrate the directory schema extensions feature. So, rather than repeat those steps here, see the <a href="http://rickrainey.com/2015/02/21/introducing-the-azure-ad-graph-api/">Register a New Application in Azure AD</a> section of the previous post.</p><h2 id="create-a-new-console-application-using-visual-studio">Create a New Console Application Using Visual Studio</h2><p>I am also using the same console application I used in the previous post. So, I won’t be repeating the nuances of instantiating an instance of the <strong>ActiveDirectoryClient</strong> in the Azure AD Graph Client Library. I’m assuming that when you see <em>adClient</em> in the forthcoming code that you know how it was created. If not, then please go back and review the previous post.</p><p>The only change I did make in this version of the application is that I updated the NuGet package for the Active Directory Graph Client Library. It wasn’t necessary for this post, I just updated to get the latest package. So, for the sample code in this post, I’m using these two NuGet packages.</p><ol><li><a href="https://www.nuget.org/packages/Microsoft.IdentityModel.Clients.ActiveDirectory/2.14.201151115">Active Directory Authentication Library (ADAL)</a>, v2.14.201151115<li><a href="https://www.nuget.org/packages/Microsoft.Azure.ActiveDirectory.GraphClient/2.0.6">Azure Active Directory Graph Client Library</a>, v2.06</ol><p>Perfect! Now with those disclaimers out of the way, let’s dive right into directory schema extensions.</p><h2 id="define-a-model-for-vehicle-information">Define a Model for Vehicle Information</h2><p>In this sample scenario, I added a simple class to hold essential vehicle information that my application will need as shown here. Notice that I’m not using properties but instead just member variables. This helps to reduce the size of the object when it is serialized as binary and therefore intentional in light of limitation #2 above.</p><div class="language-c# highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">VehicleInfo</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Year</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Make</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Model</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Color</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>You may be thinking that defining a complex type like this violates limitation #1 above. In fact, you can represent an instance of a complex type using String or Binary data and I’ll show you both. If you want to see some examples of simple String extension properties, then take a look at the blog from the Azure AD Graph Team referenced at the bottom of this post.</p><p>Now, for instances of <strong>VehicleInfo</strong> to be available as a property for users in my directory, I need to first register anextension property with Azure AD.</p><h2 id="register-an-extension-property-in-azure-ad">Register an Extension Property in Azure AD</h2><p>Extension properties are defined using the <strong>ExtensionProperty</strong> class from the Azure AD Graph Client Library. To register an extension property you need to create one and set just a few required properties. This is a one-time operation. The extension property for my vehicle information data is shown here.</p><div class="language-c# highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="c1">// Create the extension property</span>
<span class="kt">string</span> <span class="n">extPropertyName</span> <span class="p">=</span> <span class="s">"VehInfo"</span><span class="p">;</span>
<span class="n">ExtensionProperty</span> <span class="n">extensionProperty</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ExtensionProperty</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Name</span> <span class="p">=</span> <span class="n">extPropertyName</span><span class="p">,</span>
    <span class="n">DataType</span> <span class="p">=</span> <span class="s">"String"</span><span class="p">,</span>
    <span class="n">TargetObjects</span> <span class="p">=</span> <span class="p">{</span> <span class="s">"User"</span> <span class="p">}</span>
<span class="p">};</span>
</pre></table></code></div></div><p>The <strong>Name</strong> is whatever I want it to be. The <strong>DataType</strong> is set to String (for now). Remember, this can be either String or Binary (limitation #1 above). The <strong>TargetObjects</strong> I have set to User because it applies to only users in my directory (limitation #2 above).</p><p>An <strong>ExtensionProperty</strong> is always registered for an <strong>Application</strong> , which means you must first get a reference to the application registered in Azure AD. If you remember from previous posts, Azure AD generates a unique Client ID for an application when you register it in Azure AD. This Client ID can be used to locate the application (via its AppId) using a simple LINQ query as shown here.</p><div class="language-c# highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="c1">// Get a reference to our application</span>
<span class="n">Microsoft</span><span class="p">.</span><span class="n">Azure</span><span class="p">.</span><span class="n">ActiveDirectory</span><span class="p">.</span><span class="n">GraphClient</span><span class="p">.</span><span class="n">Application</span> <span class="n">app</span> <span class="p">=</span>
    <span class="p">(</span><span class="n">Microsoft</span><span class="p">.</span><span class="n">Azure</span><span class="p">.</span><span class="n">ActiveDirectory</span><span class="p">.</span><span class="n">GraphClient</span><span class="p">.</span><span class="n">Application</span><span class="p">)</span><span class="n">adClient</span><span class="p">.</span><span class="n">Applications</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">a</span> <span class="p">=&gt;</span> <span class="n">a</span><span class="p">.</span><span class="n">AppId</span> <span class="p">==</span> <span class="n">ClientID</span><span class="p">)</span>    <span class="p">.</span><span class="nf">ExecuteSingleAsync</span><span class="p">().</span><span class="n">Result</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="n">app</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">ApplicationException</span><span class="p">(</span><span class="s">"Unable to get a reference to application in Azure AD."</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>After you have a reference to the Application that was registered in Azure AD, you can register the extension for the application as shown here.</p><div class="language-c# highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c1">// Register the extension property</span>
<span class="n">app</span><span class="p">.</span><span class="n">ExtensionProperties</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">extensionProperty</span><span class="p">);</span>
<span class="n">app</span><span class="p">.</span><span class="nf">UpdateAsync</span><span class="p">();</span>
<span class="n">Task</span><span class="p">.</span><span class="nf">WaitAll</span><span class="p">();</span>
 
<span class="c1">// Apply the change to Azure AD</span>
<span class="n">app</span><span class="p">.</span><span class="nf">GetContext</span><span class="p">().</span><span class="nf">SaveChanges</span><span class="p">();</span> 
</pre></table></code></div></div><p>The <strong>Add</strong> method adds the extension property to the <strong>ExtensionProperties</strong> collection for the application. The <strong>UpdateAsync</strong> method updates the client side Application object while the <strong>SaveChanges</strong> method of the application’s context is used to actually persist the change to Azure AD.</p><p>To show what this extension property looks like in Azure AD, I used Postman to call the Azure AD Graph API to get the extension property registered from the code above. The image here shows how it is actually represented in Azure AD.</p><p><img data-proofer-ignore data-src="/assets/img/extending-azure-ad-using-the-graph-api-01.png" alt="Extension property in Azure AD" /></p><p>Notice on line 10 that the name of the extension is not just the name “VehInfo” that I specified earlier. The actual naming convention in Azure AD for an extension property is <strong>extension_[AppID]_[ExtName]</strong>, where [AppID] is the Client ID assigned to your application when you register it using the Azure Management Portal as shown below. The [ExtName] is the name that was specified in the <strong>ExtensionProperty.Name</strong> above. This naming convention is generally tr ansparent to you if you are using the Azure AD Graph Client Library. However, if you are using the REST API then this naming convention is important to follow so I’m making this point for those who may choose to use the REST API instead of the client library.</p><p><img data-proofer-ignore data-src="/assets/img/extending-azure-ad-using-the-graph-api-02.png" alt="Extension property in Azure AD" /></p><p>Now that Azure AD knows about the extension property for my application, let’s see how you can set the value of the property for a user.</p><h2 id="lookup-a-previously-registered-extension">Lookup a Previously Registered Extension</h2><p>To lookup a previously registered extension you can query the <strong>ExensionProperties</strong> collection of the application as shown here.</p><div class="language-c# highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c1">// Locate the vehicle info property extension</span>
<span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IExtensionProperty</span><span class="p">&gt;</span> <span class="n">appExtProperties</span> <span class="p">=</span> <span class="n">app</span><span class="p">.</span><span class="n">ExtensionProperties</span><span class="p">;</span>
<span class="n">IExtensionProperty</span> <span class="n">vehInfoExtProperty</span> <span class="p">=</span> <span class="n">appExtProperties</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span>
    <span class="n">prop</span> <span class="p">=&gt;</span> <span class="n">prop</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="n">extPropertyName</span><span class="p">).</span><span class="nf">FirstOrDefault</span><span class="p">();</span>
</pre></table></code></div></div><p>Unfortunately, at the time of writing this post using v2.06 of the client library, this code doesn’t always work. The <strong>ExtensionProperties</strong> collection is always empty if your application instance is not the same instance that registered the extension property. Fortunately, you can work around this by calling the <strong>ActiveDirectoryClient.GetAvailableExtensionPropertiesAsync</strong> method to query for the extension property. This approach requires some knowledge of how the extension property name is actually represented in Azure AD which I showed previously. So, with that understanding of the naming convention, I can query for the single extension property I’m looking for as shown here.</p><div class="language-c# highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c1">// Locate the vehicle info property extension (workaround)</span>
<span class="kt">string</span> <span class="n">extPropLookupName</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">"extension_{0}_{1}"</span><span class="p">,</span> <span class="n">ClientID</span><span class="p">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s">"-"</span><span class="p">,</span> <span class="s">""</span><span class="p">),</span> <span class="n">extPropertyName</span><span class="p">);</span>
<span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IExtensionProperty</span><span class="p">&gt;</span> <span class="n">allExtProperties</span> <span class="p">=</span> <span class="n">adClient</span><span class="p">.</span><span class="nf">GetAvailableExtensionPropertiesAsync</span><span class="p">(</span><span class="k">false</span><span class="p">).</span><span class="n">Result</span><span class="p">;</span>
<span class="n">IExtensionProperty</span> <span class="n">vehInfoExtProperty</span> <span class="p">=</span> <span class="n">allExtProperties</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span>
    <span class="n">extProp</span> <span class="p">=&gt;</span> <span class="n">extProp</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="n">extPropLookupName</span><span class="p">).</span><span class="nf">FirstOrDefault</span><span class="p">();</span>
</pre></table></code></div></div><h2 id="set-the-extension-property-value-for-a-user">Set the Extension Property Value for a User</h2><p>To set the extension property for a user you need to get a <strong>User</strong> reference. I’m going to stick with the “John Doe” user I’ve been using throughout this blog series and invoke a LINQ query against the <strong>ActiveDirectoryClient.Users</strong> property to get a reference to John Doe’s directory object as shown below. Next, I am creating an instance of the VehicleInfo class I defined previously and then used the <strong>User.SetExtendedProperty</strong> method to set the value for my user. Recall that our extension property can be either a String or Binary type – complex types are not supported (limitation #1 from above). To get around this, I’m using the <a href="http://www.newtonsoft.com/json">Json.NET</a>, v6.08 NuGet package to serialize my vehicleInfo object to a JSON string. Finally, I invoked UpdateAsync to update the client side object and then <strong>SaveChange</strong> on the user’s context to save the change in Azure AD.</p><div class="language-c# highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="c1">// Set the extension property value for a user</span>
<span class="kt">var</span> <span class="n">upn</span> <span class="p">=</span> <span class="s">"johndoe@cloudalloc.com"</span><span class="p">;</span>
<span class="n">User</span> <span class="n">user</span> <span class="p">=</span> <span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="n">adClient</span><span class="p">.</span><span class="n">Users</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">u</span> <span class="p">=&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">amp</span><span class="p">;</span><span class="n">amp</span><span class="p">;</span><span class="n">gt</span><span class="p">;</span> <span class="n">u</span><span class="p">.</span><span class="n">UserPrincipalName</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span>
    <span class="n">upn</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">CurrentCultureIgnoreCase</span><span class="p">)).</span><span class="nf">ExecuteSingleAsync</span><span class="p">().</span><span class="n">Result</span><span class="p">;</span>
 
<span class="k">if</span> <span class="p">(</span><span class="n">user</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">vehicleInfo</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">VehicleInfo</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Make</span> <span class="p">=</span> <span class="s">"Ford"</span><span class="p">,</span>
        <span class="n">Model</span> <span class="p">=</span> <span class="s">"F150"</span><span class="p">,</span>
        <span class="n">Color</span> <span class="p">=</span> <span class="s">"Silver"</span><span class="p">,</span>
        <span class="n">Year</span> <span class="p">=</span> <span class="m">2014</span>
    <span class="p">};</span>
 
    <span class="n">user</span><span class="p">.</span><span class="nf">SetExtendedProperty</span><span class="p">(</span><span class="n">vehInfoExtProperty</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">JsonConvert</span><span class="p">.</span><span class="nf">SerializeObject</span><span class="p">(</span><span class="n">vehicleInfo</span><span class="p">));</span>
    <span class="n">user</span><span class="p">.</span><span class="nf">UpdateAsync</span><span class="p">();</span>
    <span class="n">Task</span><span class="p">.</span><span class="nf">WaitAll</span><span class="p">();</span>
 
    <span class="c1">// Save the extended property value to Azure AD.</span>
    <span class="n">user</span><span class="p">.</span><span class="nf">GetContext</span><span class="p">().</span><span class="nf">SaveChanges</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The code above results in John Doe’s directory object being updated with the extension property value as shown below . On line 41 you can see the extension property and the JSON representation of the object.</p><p><img data-proofer-ignore data-src="/assets/img/extending-azure-ad-using-the-graph-api-03.png" alt="Extension property in Azure AD" /></p><h2 id="retrieve-the-extension-property-value-for-a-user">Retrieve the Extension Property Value for a User</h2><p>To retrieve the value of an extension property for a user you can query the collection returned from the User.GetExtendedProperties method as shown here. And since I’m serializing my complex type to a JSON string when I store it, I am de-serializing it back into a VehicleInfo object when I get it back.</p><div class="language-c# highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="c1">// Retrieve the extension property value for a user</span>
<span class="n">VehicleInfo</span> <span class="n">vehInfo</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">userExtProperty</span> <span class="p">=</span> <span class="n">user</span><span class="p">.</span><span class="nf">GetExtendedProperties</span><span class="p">().</span><span class="nf">Where</span><span class="p">(</span>
    <span class="n">extProp</span> <span class="p">=&gt;</span> <span class="n">extProp</span><span class="p">.</span><span class="n">Key</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span>
        <span class="n">vehInfoExtProperty</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>
        <span class="n">StringComparison</span><span class="p">.</span><span class="n">CurrentCultureIgnoreCase</span><span class="p">)).</span><span class="nf">FirstOrDefault</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="n">userExtProperty</span><span class="p">.</span><span class="n">Value</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">vehInfo</span> <span class="p">=</span> <span class="n">JsonConvert</span><span class="p">.</span><span class="n">DeserializeObject</span><span class="p">&lt;</span><span class="n">VehicleInfo</span><span class="p">&gt;((</span><span class="kt">string</span><span class="p">)</span><span class="n">userExtProperty</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="remove-the-extension-property-value-for-a-user">Remove the Extension Property Value for a User</h2><p>Removing an extension property for a user is simply a matter of setting the value to null as shown here.</p><div class="language-c# highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c1">// Remove the extended property for a user</span>
<span class="n">user</span><span class="p">.</span><span class="nf">SetExtendedProperty</span><span class="p">(</span><span class="n">vehInfoExtProperty</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
<span class="n">user</span><span class="p">.</span><span class="nf">UpdateAsync</span><span class="p">();</span>
<span class="n">Task</span><span class="p">.</span><span class="nf">WaitAll</span><span class="p">();</span>
<span class="n">user</span><span class="p">.</span><span class="nf">GetContext</span><span class="p">().</span><span class="nf">SaveChanges</span><span class="p">();</span>
</pre></table></code></div></div><p>The code above removes the extension property (line 41 in the image above) from John Doe’s directory object in Azure AD.</p><h2 id="unregister-an-extension-property-in-azure-ad">Unregister an Extension Property in Azure AD</h2><p>If your application no longer needs an extension property you should unregister/remove it to free the space for potentially other extension properties (limitation #4 above). Unregistering an extension property may be accomplished using the <strong>Remove</strong> method of the <strong>Application.ExtensionProperties</strong> collection as shown here. Note: When you unregister an extension property, it also removes it from any directory objects ( ie: users ) that you may have set the extension property for.</p><div class="language-c# highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c1">// Unregister the extension property</span>
<span class="n">app</span><span class="p">.</span><span class="n">ExtensionProperties</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="n">extensionProperty</span><span class="p">);</span>
<span class="n">app</span><span class="p">.</span><span class="nf">UpdateAsync</span><span class="p">();</span>
<span class="n">Task</span><span class="p">.</span><span class="nf">WaitAll</span><span class="p">();</span>
 
<span class="c1">// Apply the change to Azure AD</span>
<span class="n">app</span><span class="p">.</span><span class="nf">GetContext</span><span class="p">().</span><span class="nf">SaveChanges</span><span class="p">();</span> 
</pre></table></code></div></div><p>Unfortunately, at the time of this writing using v2.06 of the client library, this method does not actually remove it from Azure AD. As a workaround, the REST API to unregister an extension property does work so until this is corrected that is the only way to do this. The REST API is included in the References section at the end of this post.</p><h2 id="storing-extension-properties-as-binary-data">Storing Extension Properties as Binary Data</h2><p>As I mentioned at the beginning of this post, extension property data can also be stored as binary data. You must be mindful of the 256 byte limit just as you had to be for string data. This can be a bit tricky as the binary representation of a small data type like the one I’m using is significantly larger than its JSON representation. During tests of storing my VehicleInfo object as binary data, I was coming in at about 205 bytes which was much higher than the 70 bytes used to store it as a JSON string. Still, it’s an interesting use case so in this section I’ll show how to create a binary extension property and then store and retrieve the data.</p><p>To demonstrate this I’m going to use the <a href="https://msdn.microsoft.com/en-us/library/system.runtime.serialization.formatters.binary.binaryformatter(v=vs.110).aspx">BinaryFormatter</a> to serialize my object to binary. The BinaryFormatter requires that my class be marked with the Serializable attribute as I’ve shown below. Otherwise, my class remains unchanged.</p><div class="language-c# highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="n">Serializable</span><span class="p">]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">VehicleInfo</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Year</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Make</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Model</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Color</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="register-a-binary-extension-property-in-azure-ad">Register a Binary Extension Property in Azure AD</h2><p>To register a binary extension property with Azure AD you need to create a new <strong>ExtensionProperty</strong> and set the <strong>DataType</strong> to Binary as shown in the code below. It is exactly the same as before with just two changes that are highlighted: the name of the property and the data type being set to <em>Binary</em>.</p><div class="language-c# highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="c1">// Create the extension property</span>
<span class="kt">string</span> <span class="n">extPropertyName</span> <span class="p">=</span> <span class="s">"VehInfoAsBinary"</span><span class="p">;</span>
<span class="n">ExtensionProperty</span> <span class="n">extensionProperty</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ExtensionProperty</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Name</span> <span class="p">=</span> <span class="n">extPropertyName</span><span class="p">,</span>
    <span class="n">DataType</span> <span class="p">=</span> <span class="s">"Binary"</span><span class="p">,</span>
    <span class="n">TargetObjects</span> <span class="p">=</span> <span class="p">{</span> <span class="s">"User"</span> <span class="p">}</span>
<span class="p">};</span>
 
<span class="c1">// Get a reference to our application.</span>
<span class="n">Microsoft</span><span class="p">.</span><span class="n">Azure</span><span class="p">.</span><span class="n">ActiveDirectory</span><span class="p">.</span><span class="n">GraphClient</span><span class="p">.</span><span class="n">Application</span> <span class="n">app</span> <span class="p">=</span>
                <span class="p">(</span><span class="n">Microsoft</span><span class="p">.</span><span class="n">Azure</span><span class="p">.</span><span class="n">ActiveDirectory</span><span class="p">.</span><span class="n">GraphClient</span><span class="p">.</span><span class="n">Application</span><span class="p">)</span><span class="n">adClient</span><span class="p">.</span><span class="n">Applications</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span>
    <span class="n">a</span> <span class="p">=&gt;</span> <span class="n">a</span><span class="p">.</span><span class="n">AppId</span> <span class="p">==</span> <span class="n">ClientID</span><span class="p">).</span><span class="nf">ExecuteSingleAsync</span><span class="p">().</span><span class="n">Result</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">app</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">ApplicationException</span><span class="p">(</span><span class="s">"Unable to get a reference to application in Azure AD."</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="c1">// Register the extension property</span>
<span class="n">app</span><span class="p">.</span><span class="n">ExtensionProperties</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">extensionProperty</span><span class="p">);</span>
<span class="n">app</span><span class="p">.</span><span class="nf">UpdateAsync</span><span class="p">();</span>
<span class="n">Task</span><span class="p">.</span><span class="nf">WaitAll</span><span class="p">();</span>
 
<span class="c1">// Apply the change to Azure AD</span>
<span class="n">app</span><span class="p">.</span><span class="nf">GetContext</span><span class="p">().</span><span class="nf">SaveChanges</span><span class="p">();</span>
</pre></table></code></div></div><p>The code above results in my directory now having two extension properties registered as shown below.</p><p><img data-proofer-ignore data-src="/assets/img/extending-azure-ad-using-the-graph-api-04.png" alt="Extension property in Azure AD" /></p><h2 id="set-the-binary-extension-property-value-for-a-user">Set the Binary Extension Property Value for a User</h2><p>An example of how this data can be set using the BinaryFormatter is shown below. As you can see, it is essentially the same code with just a few changes highlighted to serialize the data to binary.</p><div class="language-c# highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="c1">// Set the extension property value for a user</span>
<span class="kt">var</span> <span class="n">upn</span> <span class="p">=</span> <span class="s">"johndoe@cloudalloc.com"</span><span class="p">;</span>
<span class="n">User</span> <span class="n">user</span> <span class="p">=</span> <span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="n">adClient</span><span class="p">.</span><span class="n">Users</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">u</span> <span class="p">=&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">gt</span><span class="p">;</span> <span class="n">u</span><span class="p">.</span><span class="n">UserPrincipalName</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span>
                <span class="n">upn</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">CurrentCultureIgnoreCase</span><span class="p">)).</span><span class="nf">ExecuteSingleAsync</span><span class="p">().</span><span class="n">Result</span><span class="p">;</span>
 
<span class="k">if</span> <span class="p">(</span><span class="n">user</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">vehicleInfo</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">VehicleInfo</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Make</span> <span class="p">=</span> <span class="s">"Ford"</span><span class="p">,</span>
        <span class="n">Model</span> <span class="p">=</span> <span class="s">"F150"</span><span class="p">,</span>
        <span class="n">Color</span> <span class="p">=</span> <span class="s">"Silver"</span><span class="p">,</span>
        <span class="n">Year</span> <span class="p">=</span> <span class="m">2014</span>
    <span class="p">};</span>
 
    <span class="n">BinaryFormatter</span> <span class="n">binaryFormatter</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">BinaryFormatter</span><span class="p">();</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">MemoryStream</span> <span class="n">memoryStream</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MemoryStream</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">binaryFormatter</span><span class="p">.</span><span class="nf">Serialize</span><span class="p">(</span><span class="n">memoryStream</span><span class="p">,</span> <span class="n">vehicleInfo</span><span class="p">);</span>
        <span class="n">user</span><span class="p">.</span><span class="nf">SetExtendedProperty</span><span class="p">(</span><span class="n">vehInfoExtProperty</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">memoryStream</span><span class="p">.</span><span class="nf">GetBuffer</span><span class="p">());</span>
        <span class="n">user</span><span class="p">.</span><span class="nf">UpdateAsync</span><span class="p">();</span>
        <span class="n">Task</span><span class="p">.</span><span class="nf">WaitAll</span><span class="p">();</span>
 
        <span class="c1">// Save the extended property value to Azure AD.</span>
        <span class="n">user</span><span class="p">.</span><span class="nf">GetContext</span><span class="p">().</span><span class="nf">SaveChanges</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The code above results in John Doe’s directory object being updated with the extension property value as shown below. On line 41 is a property indicating that the extension property is a Binary extension and line 42 shows the actual value of the extension property (in binary).</p><p><img data-proofer-ignore data-src="/assets/img/extending-azure-ad-using-the-graph-api-05.png" alt="Extension property in Azure AD" /></p><h2 id="retrieve-the-binary-extension-property-value-for-a-user">Retrieve the Binary Extension Property Value for a User</h2><p>The code below is an example of how you could read the binary extension property data and de-serialize it back into a VehicleInfo object. Again, the code that is different has been highlighted.</p><div class="language-c# highlighter-rouge"><div class="code-header"> <span text-data=" C# "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="c1">// Retrieve the extension property value for a user</span>
<span class="n">VehicleInfo</span> <span class="n">vehInfo</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">userExtProperty</span> <span class="p">=</span> <span class="n">user</span><span class="p">.</span><span class="nf">GetExtendedProperties</span><span class="p">().</span><span class="nf">Where</span><span class="p">(</span>
    <span class="n">extProp</span> <span class="p">=&gt;</span> <span class="n">extProp</span><span class="p">.</span><span class="n">Key</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span>
        <span class="n">vehInfoExtProperty</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>
        <span class="n">StringComparison</span><span class="p">.</span><span class="n">CurrentCultureIgnoreCase</span><span class="p">)).</span><span class="nf">FirstOrDefault</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="n">userExtProperty</span><span class="p">.</span><span class="n">Value</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">MemoryStream</span> <span class="n">memoryStream</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MemoryStream</span><span class="p">((</span><span class="kt">byte</span><span class="p">[])</span><span class="n">userExtProperty</span><span class="p">.</span><span class="n">Value</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">vehInfo</span> <span class="p">=</span> <span class="p">(</span><span class="n">VehicleInfo</span><span class="p">)</span><span class="n">binaryFormatter</span><span class="p">.</span><span class="nf">Deserialize</span><span class="p">(</span><span class="n">memoryStream</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="summary">Summary</h2><p>In this pos t I showed you how you can used Azure AD Graph API Directory Schema Extensions to extend the schema in Azure AD. I discussed constraints that you must accept when using this feature and then showed you how you can use the Azure AD Graph Client Library to register extension properties, store, retrieve data using the property, and then remove the extension property. I showed how you can store complex types as a JSON string and also how it can be stored as binary data.</p><p>For additional information on this feature I encourage you to look at the Azure AD Graph API Directory Schema Extensions documentation referenced in the References section below. Also, take a look at the post from the Azure AD Graph Team where they demonstrate using extension properties for simple string types.</p><h2 id="references">References</h2><ul><li><a href="https://msdn.microsoft.com/library/azure/ad/graph/howto/azure-ad-graph-api-directory-schema-extensions">Azure AD Graph API Directory Schema Extensions</a><li><a href="http://blogs.msdn.com/b/aadgraphteam/archive/2014/12/12/announcing-azure-ad-graph-api-client-library-2-0.aspx">Azure AD Graph Team Blog</a></ul><div id="disqus_thread"></div><script> /** * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS. * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/ /* var disqus_config = function () { this.page.url = ""; // Replace PAGE_URL with your page's canonical URL variable this.page.identifier = "/2015/03/27/extending-azure-ad-using-the-graph-api/"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable }; */ (function() { // DON'T EDIT BELOW THIS LINE var d = document, s = d.createElement('script'); s.src = 'https://rickrainey.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Extending Azure AD using the Graph API - Rick Rainey&url=https://rickrainey.com/2015/03/27/extending-azure-ad-using-the-graph-api/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Extending Azure AD using the Graph API - Rick Rainey&u=https://rickrainey.com/2015/03/27/extending-azure-ad-using-the-graph-api/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Extending Azure AD using the Graph API - Rick Rainey&url=https://rickrainey.com/2015/03/27/extending-azure-ad-using-the-graph-api/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/ubuntu-dev-setup/">Developer Laptop Setup on Ubuntu</a><li><a href="/posts/ckad-tips/">CKAD Exam Tips</a><li><a href="/2013/04/16/polyglot-persistence-in-windows-azure/">Polyglot Persistence in Windows Azure</a><li><a href="/2013/05/22/implementing-polyglot-persistence-part-1/">Implementing Polyglot Persistence – Part 1</a><li><a href="/2013/05/27/setting-up-a-neo4j-server-running-on-ubuntu-in-windows-azure/">Setting up a Neo4j Server running on Ubuntu in Windows Azure</a></ul></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/ubuntu-dev-setup/"><div class="card-body"> <span class="timeago small" >Dec 6, 2021<i class="unloaded">2021-12-06T09:00:00-06:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Developer Laptop Setup on Ubuntu</h3><div class="text-muted small"><p> This blog is really a crutch for me to remember how I like to setup my Ubuntu desktop for development work. I recently got a new laptop and had to go through the process again of setting it up the ...</p></div></div></a></div><div class="card"> <a href="/posts/ckad-tips/"><div class="card-body"> <span class="timeago small" >Oct 12, 2021<i class="unloaded">2021-10-12T10:00:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>CKAD Exam Tips</h3><div class="text-muted small"><p> I recently took and passed the CKAD Exam and now the proud owner of the CKAD Certification issued by The Linux Foundation. Like so many others who have accomplished this, I decided to share some ti...</p></div></div></a></div><div class="card"> <a href="/2016/06/22/add-a-custom-device-to-the-azure-iot-suite-remote-monitoring-solution/"><div class="card-body"> <span class="timeago small" >Jun 22, 2016<i class="unloaded">2016-06-22T16:06:04-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Add a custom device to the Azure IoT Suite Remote Monitoring solution</h3><div class="text-muted small"><p> Today, Azure IoT Suite provides two end-to-end IoT solutions; Predictive Maintenance and Remote Monitoring. These solutions can be deployed into your Azure subscription and running in just a few mi...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/2015/02/21/introducing-the-azure-ad-graph-api/" class="btn btn-outline-primary" prompt="Older"><p>Introducing the Azure AD Graph API</p></a> <a href="/2016/01/19/an-introduction-to-the-azure-resource-manager-arm/" class="btn btn-outline-primary" prompt="Newer"><p>An Introduction to the Azure Resource Manager (ARM)</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://rickrainey.com/2015/03/27/extending-azure-ad-using-the-graph-api/'; this.page.identifier = '/2015/03/27/extending-azure-ad-using-the-graph-api/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://rickrainey.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (modeToggle !== null) { modeToggle.addEventListener('click', reloadDisqus); window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/rickraineytx">Rick Rainey</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
